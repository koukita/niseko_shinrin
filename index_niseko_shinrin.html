<!DOCTYPE html>
<html>
<head>
</head>
<body>
    <meta charset="utf-8" />
    <title>北海道ニセコ町森林位置図</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        #map {
          width: 90%;
          height: 700px;
          border: 1px solid #000000;
        }
    </style>

    この地図は北海道ニセコ町の森林の位置と地番図を表示したものです。<br>
    </style>
    <div><font color="darkcyan"><b>地図の表示切替</b></font></div>
    <input type="checkbox" id="ck_shinrin" checked> 森林地図
    <input type="checkbox" id="ck_chiban"  checked> 地番図    

    <div id="map"></div><!-- 地図表示エリア -->
    出典：森林データ【<a href="https://www.pref.hokkaido.lg.jp/sr/srk/A004/B003/">北海道森林情報オープンデータ</a>】、   
    地番図【<a href="https://www.harp.lg.jp/opendata/dataset/1750.html">地番図データ（GIS用）【北海道ニセコ町】（北海道オープンデータポータル）</a>】<br>

    <script>
        let map = new maplibregl.Map({
            container: 'map', // container id
            //地理院地図の表示
            //参考にしたサイト（https://day-journal.com/memo/maplibregljs-005/）
            style: {
                version: 8,
                glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf", //日本語ラベルを表示する際に必要
                sources: {
                    t_pale: {
                        type: 'raster',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution:
                            '<a href="https://maplibre.org/maplibre-gl-js-docs/api/" target="_blank">MapLibre GL JS</a>｜\
                            <a href="http://www.gsi.go.jp/kikakuchousei/kikakuchousei40182.html" target="_blank">地理院タイル</a><br>',
                    },
                },
                layers: [
                    {
                        id: 't_pale',
                        type: 'raster',
                        source: 't_pale',
                        minzoom: 0,
                        maxzoom: 18,
                    },
                ],
            },        
            center: [140.688014, 42.804915], // starting position [lng, lat]
            zoom: 12, // starting zoom
        });

        map.on('load',function(){
            map.addSource('shinrin',{
                type:'geojson',
                data:'https://koukita.github.io/niseko_shinrin/data/2022_niseko_town_shouhan.geojson'
            });
            map.addSource('chiban',{
                type:'geojson',
                data:'https://koukita.github.io/niseko_shinrin/data/20230701_niseko_town_hokkaido_chibanzu.geojson'
            });

            //塗りつぶし
            map.addLayer({
                'id': 'shinrin_fill', //ダブらない任意の名称
                'type': 'fill',
                'source': 'shinrin',  //上の「addSource」で指定した名称
                'layout': {},
                'paint': {
                    'fill-color': '#90ee90',
                    'fill-opacity': 0.5,
                }
            });
            map.addLayer({
                'id': 'chiban_fill', //ダブらない任意の名称
                'type': 'fill',
                'source': 'chiban',  //上の「addSource」で指定した名称
                'layout': {},
                'paint': {
                    'fill-color': '#ff0000',
                    'fill-opacity': 0.1,
                }
            });

            //ポリゴンの枠線を表示
            map.addLayer({
                'id': 'shinrin_line', //ダブらない任意の名称
                'type': 'line',
                'source': 'shinrin',  //上の「addSource」で指定した名称
                'layout': {},
                'paint': {
                    'line-color': '#000000',
                    'line-width': 1,
                }
            });

            map.addLayer({
                'id': 'chiban_line', //ダブらない任意の名称
                'type': 'line',
                'source': 'chiban',  //上の「addSource」で指定した名称
                'layout': {},
                'paint': {
                    'line-color': '#ff0000',
                    'line-width': 1,
                }
            });

            //ラベルの設定
            map.addLayer({
                'id': 'shinrin_label', //ダブらない任意の名称
                'type': 'symbol',
                'source': 'shinrin',  //上の「addSource」で指定した名称
                'minzoom': 10,
                'layout': {
                    'text-field': ['get', 'SYOLBL'],
                    'text-variable-anchor': ['center'],
                    'text-radial-offset': 0,
                    'text-padding': 10, //テキストから指定したピクセル値の範囲にあるラベルを表示しない
                    'text-justify': 'auto',
                    'text-size':12,
                    //'icon-image': "circle_8"
                },
                'paint': {
                    'text-color': '#006400',  //文字の色
                    'text-halo-color': 'rgb(255, 255, 255)', //文字の縁取り色
                    'text-halo-width': 2,  //文字の縁取り幅
                }

            });
            map.addLayer({
                'id': 'chiban_label', //ダブらない任意の名称
                'type': 'symbol',
                'source': 'chiban',  //上の「addSource」で指定した名称
                'minzoom': 10,
                'layout': {
                    'text-field': ['get', '地番'],
                    'text-variable-anchor': ['center'],
                    'text-radial-offset': 0,
                    'text-padding': 10, //テキストから指定したピクセル値の範囲にあるラベルを表示しない
                    'text-justify': 'auto',
                    'text-size':10,
                    //'icon-image': "circle_8"
                },
                'paint': {
                    'text-color': '#ff0000',  //文字の色
                    'text-halo-color': 'rgb(255, 255, 255)', //文字の縁取り色
                    'text-halo-width': 2,  //文字の縁取り幅
                }

            });
        });
        // 地図上でクリックしたときの処理
        //参考にしたサイト（http://taustation.com/maplibre-popup/）
        map.on('click', (evt) => {
            // クリック位置の経緯度
            let lng = evt.lngLat.lng;
            let lat = evt.lngLat.lat;
            // クリック位置のFeature群を取得／レイヤーを限定している
            let features = map.queryRenderedFeatures(evt.point, {layers: ['shinrin_fill','chiban_fill']});
            let popup_shinrin = ''
            let popup_chiban = ''
            // 取得したFeature群の属性等をコンソールに表示する
            features.forEach((feature) => {
                if (typeof feature !== 'undefined') {
                    //ポップアップのテーブルをリストから作成する
                    let popupitem = "";
                    //ポップアップ時に表示する吹き出し（テーブル）の設定
                    if (feature.properties['SYOLBL'] !== undefined){
                        popup_shinrin = '<b>森林地図</b><table width="300">\
                            <col width="100">\
                            <col width="200">\
                                <tr>\
                                    <th scope="row">林班</th>\
                                    <td>' + String(feature.properties['林班']) + '</td>\
                                </tr>\
                                <tr>\
                                    <th scope="row">小班</th>\
                                    <td>' + String(feature.properties['小班']) + '</td>\
                                </tr>\
                                <tr>\
                                    <th scope="row">市町村名</th>\
                                    <td>' + String(feature.properties['市町村名']) + '</td>\
                                </tr>\
                            </table>';
                    }; 
                    if (feature.properties['地番'] !== undefined) {
                    popup_chiban = '<b>地番図</b><table width="300">\
                        <col width="100">\
                        <col width="200">\
                            <tr>\
                                <th scope="row">大字名称</th>\
                                <td>' + String(feature.properties['大字名称']) + '</td>\
                            </tr>\
                            <tr>\
                                <th scope="row">小字名称</th>\
                                <td>' + String(feature.properties['小字名称']) + '</td>\
                            </tr>\
                            <tr>\
                                <th scope="row">地番</th>\
                                <td>' + String(feature.properties['地番']) + '</td>\
                            </tr>\
                        </table>';
                
                    };                    

                };
            });
            let popup = new maplibregl.Popup({
                        closeOnClick: true,
                        className: 'popup'
                    })
                    .setLngLat([lng, lat])
                    .setHTML(popup_shinrin + popup_chiban)
                    .setMaxWidth("300px")
                    .addTo(map);

        });
 
 
 
        // チェックボックスで表示の切り替え
        let check_shirin = document.getElementById('ck_shinrin');
        let check_chiban = document.getElementById('ck_chiban');
        
        //　森林地図の表示切り替え
        ck_shinrin.addEventListener('change',function(){ //チェックボックスが変化したときの処理
            if(check_shirin.checked){
                map.setLayoutProperty('shinrin_fill', 'visibility', 'visible');
                map.setLayoutProperty('shinrin_line', 'visibility', 'visible');
                map.setLayoutProperty('shinrin_label', 'visibility', 'visible');
            } else {
                map.setLayoutProperty('shinrin_fill', 'visibility', 'none');
                map.setLayoutProperty('shinrin_line', 'visibility', 'none');
                map.setLayoutProperty('shinrin_label', 'visibility', 'none'); 
            }
        });

        //　地番図の表示切り替え
        ck_chiban.addEventListener('change',function(){ //チェックボックスが変化したときの処理
            if(check_chiban.checked){
                map.setLayoutProperty('chiban_fill', 'visibility', 'visible');
                map.setLayoutProperty('chiban_line', 'visibility', 'visible');
                map.setLayoutProperty('chiban_label', 'visibility', 'visible');
            } else {
                map.setLayoutProperty('chiban_fill', 'visibility', 'none');
                map.setLayoutProperty('chiban_line', 'visibility', 'none');
                map.setLayoutProperty('chiban_label', 'visibility', 'none'); 
            }
        });

        //UI
        map.addControl(new maplibregl.GeolocateControl({positionOptions: {enableHighAccuracy: true},trackUserLocation: true}), 'top-left');  //現在地の表示
        map.addControl(new maplibregl.NavigationControl(), 'top-left');  //ズームコントロール
        map.addControl(new maplibregl.ScaleControl() );  //スケールバー
        //map.addControl(new maplibregl.AttributionControl({customAttribution: "custom attribution" })); // you can add

        //debug
        //map.showTileBoundaries = true;
        //map.showCollisionBoxes = true;


    </script>

</body>
</html>